<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Fazenda do Rosa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --verde-escuro: #4B4F36;
            --verde-medio: #97A25F;
            --bege: #E9D9CD;
            --cinza-taupe: #ADA192;
            --branco-esverdeado: #F7FDF2;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--branco-esverdeado); color: var(--verde-escuro); }
        .sidebar-link { transition: all 0.2s ease-in-out; }
        .sidebar-link:hover, .sidebar-link.active { background-color: var(--verde-medio); color: white; }
        .modal-overlay { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out; }
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.5s; }
        .loader { border: 4px solid #e2e8f0; border-top: 4px solid var(--verde-medio); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .sortable-ghost { background: var(--bege); opacity: 0.5; }
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media print {
            body * { visibility: hidden; }
            .printable-area, .printable-area * { visibility: visible; }
            .printable-area { position: absolute; left: 0; top: 0; width: 100%; padding: 10px; font-size: 11px; }
            .no-print, .no-print * { display: none !important; }
            .page-break { page-break-after: always; }
            h1, h2, h3, h4, h5, h6 { font-weight: bold; }
            .comanda-header { background-color: #f3f4f6 !important; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body class="text-[var(--verde-escuro)]">

    <div id="login-view" class="flex justify-center items-center h-screen bg-[var(--bege)] no-print">
        <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-lg">
            <h2 class="text-3xl font-bold text-center text-[var(--verde-escuro)] mb-2">Painel Administrativo</h2>
            <p class="text-center text-[var(--cinza-taupe)] mb-8">Fazenda do Rosa</p>
            <div id="login-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6 hidden" role="alert"></div>
            <div class="space-y-6">
                <div>
                    <label for="email" class="block text-sm font-medium text-[var(--verde-escuro)]">Email</label>
                    <input type="email" id="email" class="mt-1 block w-full px-3 py-2 bg-white border border-[var(--cinza-taupe)] rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--verde-medio)] focus:ring-1 focus:ring-[var(--verde-medio)]" value="admin@fazenda.com">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-[var(--verde-escuro)]">Senha</label>
                    <input type="password" id="password" class="mt-1 block w-full px-3 py-2 bg-white border border-[var(--cinza-taupe)] rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--verde-medio)] focus:ring-1 focus:ring-[var(--verde-medio)]" value="123456">
                </div>
                <button id="login-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[var(--verde-medio)] hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--verde-medio)]">
                    Entrar
                </button>
            </div>
        </div>
    </div>
    
    <div id="app-view" class="hidden">
        <div class="flex h-screen bg-[var(--branco-esverdeado)]">
            <aside class="w-64 bg-[var(--verde-escuro)] text-white flex flex-col no-print">
                <div class="h-20 flex items-center justify-center border-b border-gray-700">
                    <h1 class="text-2xl font-bold">Fazenda do Rosa</h1>
                </div>
                <nav class="flex-1 px-4 py-4 space-y-2">
                    <a href="#" class="sidebar-link flex items-center px-4 py-2 rounded-lg" data-target="dashboard">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                        Dashboard
                    </a>
                    <a href="#" class="sidebar-link flex items-center px-4 py-2 rounded-lg" data-target="orders">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        Pedidos
                    </a>
                    <a href="#" class="sidebar-link flex items-center px-4 py-2 rounded-lg" data-target="menu">
                         <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        Cardápio
                    </a>
                    <a href="#" class="sidebar-link flex items-center px-4 py-2 rounded-lg" data-target="settings">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Configurações
                    </a>
                </nav>
                <div class="mt-auto p-4 space-y-2 border-t border-gray-700">
                     <a href="/" target="_blank" class="sidebar-link flex items-center px-4 py-2 rounded-lg hover:bg-[var(--verde-medio)]">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                        Ver Formulário
                    </a>
                     <a href="#" id="logout-btn" class="sidebar-link flex items-center px-4 py-2 rounded-lg hover:bg-red-500">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        Sair
                    </a>
                </div>
            </aside>

            <main class="flex-1 flex flex-col overflow-hidden">
                <header class="h-20 bg-white flex items-center justify-between px-8 border-b border-[var(--cinza-taupe)] no-print">
                    <h2 id="main-title" class="text-2xl font-semibold"></h2>
                    <div class="flex items-center">
                        <span id="user-email" class="mr-4 text-[var(--cinza-taupe)]"></span>
                        <div class="w-10 h-10 bg-[var(--bege)] rounded-full flex items-center justify-center text-[var(--verde-escuro)]">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        </div>
                    </div>
                </header>
                <div class="flex-1 p-4 md:p-8 overflow-y-auto">
                    <section id="dashboard" class="content-section"></section>
                    <section id="orders" class="content-section"></section>
                    <section id="menu" class="content-section"></section>
                    <section id="settings" class="content-section"></section>
                </div>
            </main>
        </div>
    </div>
    
    <div id="modal-container" class="no-print"></div>
    <div id="print-container"></div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyAjAUVa7_4cAHtFqm8xBuzDVzxDknPMYJM",
            authDomain: "cafe-da-fazenda-a2ec3.firebaseapp.com",
            projectId: "cafe-da-fazenda-a2ec3",
            storageBucket: "cafe-da-fazenda-a2ec3.appspot.com",
            messagingSenderId: "604485035435",
            appId: "1:604485035435:web:876f003565cec1ac4a5eee"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let activeListeners = [];
        let sortableInstances = [];
        let activeCharts = [];


        // --- GLOBAL HELPER FUNCTIONS ---
        window.closeModal = (id) => {
            const modal = document.getElementById(id);
            if(modal) modal.remove();
        }

        function showLoader(elementId) {
            const container = document.getElementById(elementId);
            if (container) {
                container.innerHTML = `<div class="flex justify-center items-center h-64"><div class="loader"></div></div>`;
            }
        }
        
        function showConfirmModal(message, onConfirm) {
            const modalId = `confirm-modal-${Date.now()}`;
            const modalHTML = `
            <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 modal-overlay">
                <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md modal-content">
                    <h3 class="text-xl font-bold mb-4">Confirmação</h3>
                    <p class="text-[var(--verde-escuro)] mb-6">${message}</p>
                    <div class="flex justify-end gap-4">
                        <button id="cancel-btn" class="bg-gray-200 hover:bg-gray-300 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                        <button id="confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Confirmar</button>
                    </div>
                </div>
            </div>`;
            document.getElementById('modal-container').insertAdjacentHTML('beforeend', modalHTML);

            document.getElementById('confirm-btn').onclick = () => {
                onConfirm();
                closeModal(modalId);
            };
            document.getElementById('cancel-btn').onclick = () => closeModal(modalId);
        }

        function clearListeners() {
            activeListeners.forEach(unsubscribe => unsubscribe());
            activeListeners = [];
            sortableInstances.forEach(sortable => sortable.destroy());
            sortableInstances = [];
            activeCharts.forEach(chart => chart.destroy());
            activeCharts = [];
        }

        // --- AUTHENTICATION ---
        auth.onAuthStateChanged(user => {
            clearListeners();
            if (user) {
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('app-view').classList.remove('hidden');
                document.getElementById('user-email').textContent = user.email;
                initializeApp();
            } else {
                document.getElementById('login-view').classList.remove('hidden');
                document.getElementById('app-view').classList.add('hidden');
            }
        });

        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('login-error');
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                loginError.textContent = "Erro: " + error.message;
                loginError.classList.remove('hidden');
            }
        });
        document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());

        // --- APP INITIALIZATION & NAVIGATION ---
        function initializeApp() {
            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            
            function navigateTo(targetId) {
                clearListeners();
                document.querySelectorAll('.content-section').forEach(section => section.style.display = 'none');
                const targetSection = document.getElementById(targetId);
                targetSection.style.display = 'block';

                sidebarLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.dataset.target === targetId) {
                        link.classList.add('active');
                        document.getElementById('main-title').textContent = link.textContent.trim();
                    }
                });

                switch(targetId) {
                    case 'dashboard': loadDashboard(); break;
                    case 'orders': loadOrders(); break;
                    case 'menu': loadMenu(); break;
                    case 'settings': loadSettings(); break;
                }
            }

            sidebarLinks.forEach(link => {
                const target = link.dataset.target;
                if (target) {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        navigateTo(target);
                    });
                }
            });
            
            navigateTo('dashboard');
        }

        // --- DASHBOARD LOGIC ---
        function loadDashboard() {
            showLoader('dashboard');
            const unsubscribe = db.collection('pedidos').orderBy('timestampPedido', 'desc').onSnapshot(snapshot => {
                const orders = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                renderDashboard(orders);
            }, error => console.error("Error loading dashboard data:", error));
            activeListeners.push(unsubscribe);
        }

        function renderDashboard(orders) {
            const newOrders = orders.filter(o => o.status === 'Novo').length;
            const inPrepOrders = orders.filter(o => o.status === 'Em Preparação').length;
            const deliveredToday = orders.filter(o => {
                const orderDate = o.timestampPedido?.toDate();
                const today = new Date();
                return o.status === 'Entregue' && orderDate && orderDate.toDateString() === today.toDateString();
            }).length;

            const recentOpenOrders = orders.filter(o => ['Novo', 'Em Preparação'].includes(o.status)).slice(0, 5);

            const itemCounts = {};
            orders.forEach(order => {
                order.itensPedido.forEach(item => {
                    const itemName = item.nomeItem.split(' - ')[0]; // Group by base item name
                    itemCounts[itemName] = (itemCounts[itemName] || 0) + item.quantidade;
                });
            });
            const topItems = Object.entries(itemCounts).sort(([,a],[,b]) => b-a).slice(0, 5);

            const dashboardHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow border border-[var(--cinza-taupe)]"><h4 class="font-semibold text-[var(--cinza-taupe)]">Novos Pedidos</h4><p class="text-4xl font-bold mt-2">${newOrders}</p></div>
                    <div class="bg-white p-6 rounded-xl shadow border border-[var(--cinza-taupe)]"><h4 class="font-semibold text-[var(--cinza-taupe)]">Em Preparação</h4><p class="text-4xl font-bold mt-2">${inPrepOrders}</p></div>
                    <div class="bg-white p-6 rounded-xl shadow border border-[var(--cinza-taupe)]"><h4 class="font-semibold text-[var(--cinza-taupe)]">Entregues Hoje</h4><p class="text-4xl font-bold mt-2">${deliveredToday}</p></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow border border-[var(--cinza-taupe)]">
                        <h4 class="text-lg font-bold mb-4">Pedidos em Aberto Recentes</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead><tr class="border-b"><th class="p-3">Hóspede</th><th class="p-3">Cabana</th><th class="p-3">Entrega</th><th class="p-3">Status</th></tr></thead>
                                <tbody>
                                    ${recentOpenOrders.map(order => `<tr class="border-b hover:bg-gray-50 cursor-pointer" onclick="openOrderDetailModal('${order.id}')">
                                        <td class="p-3 font-medium">${order.hospedeNome}</td>
                                        <td class="p-3">${order.cabanaNumero}</td>
                                        <td class="p-3">${order.horarioEntrega}</td>
                                        <td class="p-3"><span class="font-medium px-2.5 py-0.5 rounded-full ${order.status === 'Novo' ? 'bg-blue-100 text-blue-800' : 'bg-amber-100 text-amber-800'}">${order.status}</span></td>
                                    </tr>`).join('')}
                                    ${recentOpenOrders.length === 0 ? '<tr><td colspan="4" class="p-3 text-center text-gray-500">Nenhum pedido em aberto.</td></tr>' : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow border border-[var(--cinza-taupe)]">
                        <h4 class="text-lg font-bold mb-4">Itens Mais Pedidos</h4>
                         <canvas id="top-items-chart"></canvas>
                    </div>
                </div>
            `;
            document.getElementById('dashboard').innerHTML = dashboardHTML;

            const ctx = document.getElementById('top-items-chart').getContext('2d');
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topItems.map(([name]) => name),
                    datasets: [{
                        label: 'Quantidade',
                        data: topItems.map(([,qty]) => qty),
                        backgroundColor: 'rgba(151, 162, 95, 0.6)',
                        borderColor: 'rgba(151, 162, 95, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true } }
                }
            });
            activeCharts.push(chart);
        }

        // --- ORDERS LOGIC (IMPROVED COMANDA) ---
        function loadOrders() {
            showLoader('orders');
            const unsubscribe = db.collection('pedidos').orderBy('timestampPedido', 'desc').onSnapshot(snapshot => {
                const orders = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                renderOrders(orders);
            }, error => console.error("Error loading orders:", error));
            activeListeners.push(unsubscribe);
        }

        function renderOrders(orders) {
            const statusColors = { 'Novo': 'bg-blue-100 text-blue-800', 'Em Preparação': 'bg-amber-100 text-amber-800', 'Entregue': 'bg-green-100 text-green-800', 'Cancelado': 'bg-red-100 text-red-800' };
            const ordersHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                    <div>
                        <h3 class="text-xl font-semibold">Pedidos Recebidos</h3>
                        <p class="text-[var(--cinza-taupe)] mt-1">A lista é atualizada em tempo real.</p>
                    </div>
                    <button onclick="printOpenOrdersSummary()" class="mt-4 sm:mt-0 bg-white border border-[var(--cinza-taupe)] hover:bg-gray-50 font-bold py-2 px-4 rounded-lg flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm7-8a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        Imprimir Resumo da Cozinha
                    </button>
                </div>
                <div class="bg-white p-2 sm:p-4 rounded-xl shadow-sm border border-[var(--cinza-taupe)]">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead><tr class="border-b bg-gray-50"><th class="p-3">Data/Hora</th><th class="p-3">Cabana</th><th class="p-3">Hóspede</th><th class="p-3">Entrega</th><th class="p-3">Status</th></tr></thead>
                            <tbody>${orders.map(order => `<tr class="border-b hover:bg-gray-50 cursor-pointer" onclick="openOrderDetailModal('${order.id}')">
                                <td class="p-3 whitespace-nowrap">${order.timestampPedido?.toDate().toLocaleString('pt-BR') || 'N/A'}</td>
                                <td class="p-3 font-medium">${order.cabanaNumero}</td><td class="p-3">${order.hospedeNome}</td><td class="p-3">${order.horarioEntrega}</td>
                                <td class="p-3"><span class="font-medium px-2.5 py-0.5 rounded-full ${statusColors[order.status] || 'bg-slate-100 text-slate-800'}">${order.status}</span></td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
            document.getElementById('orders').innerHTML = ordersHTML;
        }

        window.openOrderDetailModal = async (orderId) => {
            const doc = await db.collection('pedidos').doc(orderId).get();
            if (!doc.exists) return;
            const order = { id: doc.id, ...doc.data() };
            const modalId = `order-detail-modal-${orderId}`;

            // Group items for better display
            const hotDishes = order.itensPedido.filter(item => item.paraPessoa);
            const accompaniments = order.itensPedido.filter(item => !item.paraPessoa);
            
            const modalHTML = `
                <div id="${modalId}" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 modal-overlay">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl modal-content flex flex-col max-h-[95vh]">
                        <div id="printable-order-${orderId}" class="p-6 printable-area flex-grow overflow-y-auto">
                            <div class="text-center mb-4">
                                <h3 class="text-xl font-bold">FAZENDA DO ROSA</h3>
                                <p class="text-sm">PEDIDO DE CAFÉ DA MANHÃ</p>
                            </div>
                            <div class="comanda-header grid grid-cols-3 gap-x-4 text-sm border-y-2 border-dashed border-black py-2 mb-4 font-mono">
                                <p><strong>CABANA:</strong> <span class="text-lg font-extrabold">${order.cabanaNumero}</span></p>
                                <p><strong>HÓSPEDE:</strong> ${order.hospedeNome}</p>
                                <p><strong>ENTREGA:</strong> ${order.horarioEntrega}</p>
                                <p><strong>PESSOAS:</strong> ${order.numeroPessoas}</p>
                                <p><strong>PEDIDO:</strong> #${order.id.substring(0,6)}</p>
                                <p><strong>DATA:</strong> ${order.timestampPedido?.toDate().toLocaleDateString('pt-BR')}</p>
                            </div>
                            
                            ${hotDishes.length > 0 ? `
                            <h4 class="font-bold text-md mt-4 mb-1 uppercase tracking-wider">-- Pratos Quentes --</h4>
                            <ul class="space-y-1">
                                ${hotDishes.map(item => `<li><strong>${item.quantidade}x ${item.nomeItem}</strong> (p/ ${item.paraPessoa}) ${item.observacao ? `<br><em class="ml-4 text-gray-600 text-xs">Obs: ${item.observacao}</em>` : ''}</li>`).join('')}
                            </ul>` : ''}
                             ${order.observacoesPratosQuentes ? `<div class="mt-2"><h5 class="font-semibold text-xs uppercase">Obs. Gerais (Pratos Quentes):</h5><p class="text-sm italic pl-2 border-l-2 border-gray-300">${order.observacoesPratosQuentes}</p></div>` : ''}

                            ${accompaniments.length > 0 ? `
                            <h4 class="font-bold text-md mt-4 mb-1 uppercase tracking-wider">-- Acompanhamentos da Cesta --</h4>
                            <ul class="space-y-1 columns-2">
                                ${accompaniments.map(item => `<li><strong>${item.quantidade}x</strong> ${item.nomeItem}</li>`).join('')}
                            </ul>` : ''}

                            ${order.observacoesGerais ? `<div class="mt-4 border-t pt-2"><h4 class="font-bold text-md mb-1 uppercase">Observações Gerais do Pedido</h4><p class="text-sm font-semibold">${order.observacoesGerais}</p></div>` : ''}
                        </div>
                        <div class="bg-gray-50 p-4 border-t rounded-b-xl flex justify-between items-center no-print">
                             <div>
                                <label for="status-select" class="mr-2 font-medium">Status:</label>
                                <select id="status-select" class="border-gray-300 rounded-lg">
                                    <option value="Novo" ${order.status === 'Novo' ? 'selected' : ''}>Novo</option>
                                    <option value="Em Preparação" ${order.status === 'Em Preparação' ? 'selected' : ''}>Em Preparação</option>
                                    <option value="Entregue" ${order.status === 'Entregue' ? 'selected' : ''}>Entregue</option>
                                    <option value="Cancelado" ${order.status === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
                                </select>
                            </div>
                            <div class="flex gap-4">
                                <button class="bg-gray-200 hover:bg-gray-300 font-bold py-2 px-4 rounded-lg" onclick="closeModal('${modalId}')">Fechar</button>
                                <button onclick="printElement('printable-order-${orderId}')" class="bg-[var(--verde-escuro)] hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Imprimir</button>
                                <button onclick="updateOrderStatus('${orderId}')" class="bg-[var(--verde-medio)] hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Salvar</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            document.getElementById('modal-container').innerHTML = modalHTML;
        }

        window.updateOrderStatus = async (orderId) => {
            const newStatus = document.getElementById('status-select').value;
            await db.collection('pedidos').doc(orderId).update({ status: newStatus });
            closeModal(`order-detail-modal-${orderId}`);
        };

        window.printOpenOrdersSummary = async () => {
            const snapshot = await db.collection('pedidos').where('status', 'in', ['Novo', 'Em Preparação']).orderBy('horarioEntrega').get();
            const openOrders = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));

            if (openOrders.length === 0) {
                alert("Nenhum pedido em aberto para imprimir.");
                return;
            }

            // Group by delivery time
            const ordersByTime = openOrders.reduce((acc, order) => {
                const time = order.horarioEntrega;
                if (!acc[time]) acc[time] = [];
                acc[time].push(order);
                return acc;
            }, {});
            
            // Item Summary
            const summary = {};
            openOrders.forEach(order => {
                order.itensPedido.forEach(item => {
                    summary[item.nomeItem] = (summary[item.nomeItem] || 0) + item.quantidade;
                });
            });

            const printId = 'kitchen-summary';
            const printHTML = `
                <div id="${printId}" class="printable-area">
                    <h2 class="text-xl font-bold mb-2">Resumo da Cozinha - ${new Date().toLocaleString('pt-BR')}</h2>
                    
                    <h3 class="text-lg font-bold mt-4 mb-1 border-b">TOTAL DE ITENS</h3>
                    <table class="w-full text-left border-collapse text-xs">
                         <tbody>
                            ${Object.entries(summary).sort((a,b) => a[0].localeCompare(b[0])).map(([name, qty]) => `
                                <tr class="border-b"><td class="p-1">${name}</td><td class="p-1 text-right font-bold">${qty}</td></tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="page-break"></div>

                    <h3 class="text-lg font-bold mt-4 mb-1 border-b">PEDIDOS POR HORÁRIO</h3>
                     ${Object.keys(ordersByTime).sort().map(time => `
                        <div class="mb-4">
                            <h4 class="text-md font-bold bg-gray-200 p-1">HORÁRIO DE ENTREGA: ${time}</h4>
                            ${ordersByTime[time].map(order => `
                                <div class="border-b-2 border-dashed border-black py-2">
                                    <p><strong>${order.cabanaNumero} - ${order.hospedeNome}</strong> (${order.numeroPessoas}p)</p>
                                    <ul class="list-disc list-inside text-xs pl-2">
                                    ${order.itensPedido.map(item => `<li><strong>${item.quantidade}x</strong> ${item.nomeItem} ${item.observacao ? `<em class="text-gray-600">- Obs: ${item.observacao}</em>` : ''}</li>`).join('')}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>
                     `).join('')}
                </div>`;
            document.getElementById('print-container').innerHTML = printHTML;
            printElement(printId);
        }

        window.printElement = (elementId) => {
            const contentToPrint = document.getElementById(elementId);
            if (!contentToPrint) return;
            const printContainer = document.getElementById('print-container');
            printContainer.innerHTML = contentToPrint.innerHTML;
            window.print();
            printContainer.innerHTML = '';
        }

        // --- MENU LOGIC ---
        function loadMenu() {
            showLoader('menu');
            const unsubscribe = db.collection('cardapio').orderBy('posicao').onSnapshot(async snapshot => {
                let categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                const categoriesWithItems = await Promise.all(categories.map(async (cat) => {
                    const itemsSnapshot = await db.collection('cardapio').doc(cat.id).collection('itens').orderBy('posicao').get();
                    let items = itemsSnapshot.docs.map(itemDoc => ({ id: itemDoc.id, ...itemDoc.data() }));
                    return { ...cat, items: items };
                }));
                renderMenu(categoriesWithItems);
            }, error => {
                console.error("Error loading menu:", error);
                document.getElementById('menu').innerHTML = `<p class="text-red-500">Erro ao carregar o cardápio.</p>`;
            });
            activeListeners.push(unsubscribe);
        }

        function renderMenu(categories) {
            const menuHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-xl font-semibold">Gestão de Cardápio</h3>
                        <p class="text-[var(--cinza-taupe)] mt-1">Arraste para reordenar. As mudanças são salvas em tempo real.</p>
                    </div>
                    <button onclick="openCategoryModal()" class="bg-[var(--verde-medio)] hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Nova Categoria</button>
                </div>
                <div id="categories-list" class="space-y-6">
                ${categories.map(cat => `
                    <div class="bg-white rounded-xl shadow-sm border border-[var(--cinza-taupe)]" data-id="${cat.id}">
                        <div class="p-4 border-b border-[var(--cinza-taupe)] flex justify-between items-center bg-gray-50 rounded-t-xl">
                            <div class="flex items-center gap-4">
                                <svg class="w-5 h-5 text-gray-400 drag-handle" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                                <h4 class="text-lg font-semibold">${cat.nomeCategoria}</h4>
                            </div>
                            <div class="space-x-4">
                                <button onclick="openMenuItemModal('${cat.id}')" class="text-sm font-medium text-[var(--verde-medio)] hover:underline">Adicionar Item</button>
                                <button onclick="openCategoryModal('${cat.id}', '${cat.nomeCategoria}')" class="text-sm font-medium text-gray-500 hover:text-gray-700">Editar</button>
                            </div>
                        </div>
                        <div class="p-2">
                           <table class="w-full">
                               <tbody class="item-list" data-category-id="${cat.id}">
                                ${(cat.items || []).map(item => `
                                    <tr class="rounded-lg" data-id="${item.id}">
                                        <td class="p-3 w-10 text-center"><svg class="w-5 h-5 text-gray-300 drag-handle inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></td>
                                        <td class="p-3">
                                            <span class="font-medium">${item.nomeItem}</span>
                                            <span class="text-gray-500 text-sm ml-2">(${item.calorias || 0} kcal)</span>
                                        </td>
                                        <td class="p-3"><span class="text-sm font-medium px-2.5 py-0.5 rounded-full ${item.disponivel ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${item.disponivel ? 'Ativo' : 'Inativo'}</span></td>
                                        <td class="p-3 text-right space-x-4"><button onclick="openMenuItemModal('${cat.id}', '${item.id}')" class="text-gray-500 hover:text-[var(--verde-medio)]">Editar</button><button onclick="deleteMenuItem('${cat.id}', '${item.id}')" class="text-gray-500 hover:text-red-600">Excluir</button></td>
                                    </tr>`).join('')}
                                </tbody>
                           </table>
                        </div>
                    </div>`).join('')}
                </div>`;
            document.getElementById('menu').innerHTML = menuHTML;
            initializeMenuSortables();
        }

        // --- SETTINGS LOGIC (IMPROVED) ---
        function loadSettings() {
            showLoader('settings');
            const geralPromise = db.collection('configuracoes').doc('geral').get();
            const appPromise = db.collection('configuracoes').doc('app').get();

            Promise.all([geralPromise, appPromise]).then(([geralDoc, appDoc]) => {
                const geralConfig = geralDoc.exists ? geralDoc.data() : { cabanas: [], horariosEntrega: [] };
                const appConfig = appDoc.exists ? appDoc.data() : { nomeFazenda: '', subtitulo: '', textoIntroducao: '', textoAgradecimento: '', corPrimaria: '#97A25F', corSecundaria: '#4B4F36' };
                renderSettings(geralConfig, appConfig);
            }).catch(error => console.error("Error loading settings:", error));
        }

        function renderSettings(geralConfig, appConfig) {
            const settingsHTML = `
                 <div class="mb-6"><h3 class="text-xl font-semibold">Configurações</h3><p class="text-[var(--cinza-taupe)] mt-1">Gerencie os parâmetros do sistema e a aparência do aplicativo.</p></div>
                 <div class="space-y-8">
                     <div class="bg-white p-6 rounded-xl shadow-sm border border-[var(--cinza-taupe)]">
                        <h4 class="text-lg font-semibold mb-4">Personalização do Aplicativo</h4>
                        <div class="space-y-4">
                            <div><label class="font-medium">Nome da Fazenda</label><input type="text" id="app-nomeFazenda" class="w-full mt-1 border-gray-300 rounded-lg p-2" value="${appConfig.nomeFazenda || ''}"></div>
                            <div><label class="font-medium">Subtítulo</label><input type="text" id="app-subtitulo" class="w-full mt-1 border-gray-300 rounded-lg p-2" value="${appConfig.subtitulo || ''}"></div>
                            <div><label class="font-medium">Texto de Introdução</label><textarea id="app-textoIntroducao" class="w-full mt-1 border-gray-300 rounded-lg p-2" rows="4">${appConfig.textoIntroducao || ''}</textarea></div>
                            <div><label class="font-medium">Texto de Agradecimento</label><textarea id="app-textoAgradecimento" class="w-full mt-1 border-gray-300 rounded-lg p-2" rows="2">${appConfig.textoAgradecimento || ''}</textarea></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="font-medium">Cor Primária (Destaque)</label><input type="color" id="app-corPrimaria" class="w-full h-10 mt-1 border-gray-300 rounded-lg p-1" value="${appConfig.corPrimaria || '#97A25F'}"></div>
                                <div><label class="font-medium">Cor Secundária (Texto)</label><input type="color" id="app-corSecundaria" class="w-full h-10 mt-1 border-gray-300 rounded-lg p-1" value="${appConfig.corSecundaria || '#4B4F36'}"></div>
                            </div>
                        </div>
                        <div class="text-right mt-4"><button onclick="saveAppConfig()" class="bg-[var(--verde-medio)] hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Salvar Personalização</button></div>
                     </div>
                     <div class="bg-white p-6 rounded-xl shadow-sm border border-[var(--cinza-taupe)]">
                         <h4 class="text-lg font-semibold mb-4">Gerenciar Cabanas</h4>
                         <div id="cabanas-list" class="space-y-2 mb-4">${(geralConfig.cabanas || []).map((c, i) => `
                             <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border" data-name="${c.nomeCabana}" data-capacity="${c.capacidadeMaxima}">
                                 <div class="flex items-center gap-3"><svg class="w-5 h-5 text-gray-400 drag-handle" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg><span>${c.nomeCabana} (Cap: ${c.capacidadeMaxima})</span></div>
                                 <button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 text-sm font-medium">Remover</button>
                             </div>`).join('')}
                         </div>
                         <div class="flex flex-col sm:flex-row gap-2 mb-4">
                            <input type="text" id="new-cabana-name" placeholder="Nome da Cabana" class="flex-grow border border-gray-300 rounded-lg px-3 py-2">
                            <input type="number" id="new-cabana-capacity" placeholder="Cap." class="w-full sm:w-24 border border-gray-300 rounded-lg px-3 py-2">
                            <button id="add-cabana-btn" class="bg-gray-200 hover:bg-gray-300 font-bold py-2 px-4 rounded-lg">Adicionar</button>
                         </div>
                         <div class="text-right"><button onclick="saveList('cabanas')" class="bg-[var(--verde-medio)] hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Salvar Cabanas</button></div>
                    </div>
                     <div class="bg-white p-6 rounded-xl shadow-sm border border-[var(--cinza-taupe)]">
                        <h4 class="text-lg font-semibold mb-4">Gerenciar Horários de Entrega</h4>
                         <div id="horarios-list" class="space-y-2 mb-4">${(geralConfig.horariosEntrega || []).map((h, i) => `
                             <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border" data-value="${h}">
                                 <div class="flex items-center gap-3"><svg class="w-5 h-5 text-gray-400 drag-handle" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg><span>${h}</span></div>
                                 <button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 text-sm font-medium">Remover</button>
                             </div>`).join('')}
                         </div>
                         <div class="flex flex-col sm:flex-row gap-2 mb-4">
                            <input type="text" id="new-horario" placeholder="Novo Horário (HH:MM)" class="flex-grow border border-gray-300 rounded-lg px-3 py-2">
                            <button id="add-horario-btn" class="bg-gray-200 hover:bg-gray-300 font-bold py-2 px-4 rounded-lg">Adicionar</button>
                         </div>
                         <div class="text-right"><button onclick="saveList('horariosEntrega')" class="bg-[var(--verde-medio)] hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Salvar Horários</button></div>
                    </div>
                 </div>`;
            document.getElementById('settings').innerHTML = settingsHTML;
            initializeSettingsSortablesAndButtons();
        }

        function initializeSettingsSortablesAndButtons() {
            // ... (código existente sem alterações)
        }

        window.saveAppConfig = async () => {
            const configData = {
                nomeFazenda: document.getElementById('app-nomeFazenda').value,
                subtitulo: document.getElementById('app-subtitulo').value,
                textoIntroducao: document.getElementById('app-textoIntroducao').value,
                textoAgradecimento: document.getElementById('app-textoAgradecimento').value,
                corPrimaria: document.getElementById('app-corPrimaria').value,
                corSecundaria: document.getElementById('app-corSecundaria').value,
            };
            try {
                await db.collection('configuracoes').doc('app').set(configData, { merge: true });
                alert('Personalização salva com sucesso!');
            } catch (e) {
                alert('Erro ao salvar personalização.');
                console.error(e);
            }
        }
        
        window.saveList = async (type) => {
            // ... (código existente sem alterações)
        };

        function initializeMenuSortables() {
            // ... (código existente sem alterações)
        }
        
        // --- MENU MODAL FUNCTIONS ---

        window.openCategoryModal = (id = null, name = '') => {
            // ... (código existente sem alterações)
        };

        window.saveCategory = async (modalId, id) => {
           // ... (código existente sem alterações)
        };

        window.deleteCategory = (id) => {
           // ... (código existente sem alterações)
        };

        window.openMenuItemModal = async (categoryId, itemId = null) => {
            // ... (código existente sem alterações)
        };

        window.saveMenuItem = async (modalId, categoryId, itemId) => {
            // ... (código existente sem alterações)
        };

        window.deleteMenuItem = (categoryId, itemId) => {
            // ... (código existente sem alterações)
        };

    </script>
</body>
</html>
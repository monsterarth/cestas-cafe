<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Administração - Pedidos de Café da Manhã</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Paleta de cores extraída do seu projeto Next.js para manter a consistência visual */
        :root {
            --background: hsl(224, 71.4%, 4.1%);
            --foreground: hsl(210, 20%, 98%);
            --card: hsl(215, 27.9%, 16.9%);
            --card-foreground: hsl(210, 20%, 98%);
            --primary: hsl(47.9, 95.8%, 53.1%);
            --primary-foreground: hsl(26, 83.3%, 14.1%);
            --secondary: hsl(215, 27.9%, 16.9%);
            --secondary-foreground: hsl(210, 20%, 98%);
            --border: hsl(215, 27.9%, 16.9%);
            --ring: hsl(47.9, 95.8%, 53.1%);
            --radius: 0.5rem;
        }

        body {
            background-color: var(--background);
            color: var(--foreground);
            font-family: 'Inter', sans-serif;
        }

        .card {
            background-color: var(--card);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background-color: var(--primary);
            color: var(--primary-foreground);
            transition: background-color 0.3s;
        }

        .btn-primary:hover {
            background-color: hsl(47.9, 95.8%, 63.1%);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: var(--secondary-foreground);
            border: 1px solid var(--border);
            transition: background-color 0.3s;
        }

        .btn-secondary:hover {
             background-color: hsl(215, 27.9%, 26.9%);
        }

        .modal-content {
             background-color: var(--background);
        }

        /* Estilos para a impressão */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            h1, h2, h3, h4, p, div, span {
                color: #000 !important;
            }
            .resumo, .item-categoria {
                margin-bottom: 1rem;
                border-bottom: 1px solid #ccc;
                padding-bottom: 1rem;
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="container mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8">
            <div>
                <h1 class="text-4xl font-bold text-primary">Painel de Pedidos</h1>
                <p class="text-lg text-gray-400">Café da Manhã - Cabanas</p>
            </div>
            <div class="flex space-x-4 mt-4 md:mt-0">
                <button id="btn-comanda-geral" class="btn-primary font-bold py-2 px-6 rounded-lg">Gerar Comanda Geral</button>
            </div>
        </header>

        <main id="pedidos-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Os cards de pedidos serão inseridos aqui via JavaScript -->
        </main>
    </div>

    <!-- Modal para Detalhes do Pedido -->
    <div id="pedido-modal" class="fixed inset-0 bg-black bg-opacity-75 flex justify-center items-center hidden z-50">
        <div id="modal-content" class="modal-content card p-8 rounded-lg w-11/12 md:w-2/3 lg:w-1/2 max-w-4xl max-h-[90vh] overflow-y-auto relative">
             <button id="btn-fechar-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
            <!-- Conteúdo do modal inserido via JavaScript -->
        </div>
    </div>
    
    <!-- Área de impressão invisível -->
    <div id="print-area" class="hidden"></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Mantenha suas credenciais do Firebase aqui
        const firebaseConfig = {
            apiKey: "AIzaSyAjAUVa7_4cAHtFqm8xBuzDVzxDknPMYJM",
            authDomain: "cafe-da-fazenda-a2ec3.firebaseapp.com",
            projectId: "cafe-da-fazenda-a2ec3",
            storageBucket: "cafe-da-fazenda-a2ec3.appspot.com",
            messagingSenderId: "604485035435",
            appId: "1:604485035435:web:876f003565cec1ac4a5eee"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let pedidosData = []; // Cache local para os dados dos pedidos

        // --- MELHORIA: Mapeamento de itens para categorias ---
        const itemCategories = {
            'Pão Francês': 'Pães', 'Pão de Queijo': 'Pães', 'Croissant': 'Pães', 'Pão Integral': 'Pães',
            'Queijo': 'Frios', 'Presunto': 'Frios', 'Peito de Peru': 'Frios', 'Salame': 'Frios',
            'Mamão': 'Frutas', 'Melão': 'Frutas', 'Uva': 'Frutas', 'Morango': 'Frutas', 'Laranja': 'Frutas', 'Abacaxi': 'Frutas',
            'Café': 'Bebidas Quentes', 'Leite': 'Bebidas Quentes', 'Chocolate Quente': 'Bebidas Quentes', 'Chá': 'Bebidas Quentes',
            'Suco de Laranja': 'Bebidas Frias', 'Suco de Uva': 'Bebidas Frias', 'Água': 'Bebidas Frias', 'Iogurte': 'Bebidas Frias',
            'Ovos Mexidos': 'Pratos Quentes', 'Bacon': 'Pratos Quentes', 'Salsicha': 'Pratos Quentes', 'Panquecas': 'Pratos Quentes',
            'Granola': 'Cereais', 'Aveia': 'Cereais', 'Sucrilhos': 'Cereais',
            'Bolo de Chocolate': 'Doces', 'Bolo de Laranja': 'Doces', 'Bolo de Fubá': 'Doces', 'Geléia': 'Doces', 'Mel': 'Doces', 'Manteiga': 'Doces',
        };

        const categoryOrder = [
            "Pratos Quentes", "Pães", "Frios", "Frutas", "Bebidas Quentes", "Bebidas Frias", "Cereais", "Doces", "Outros"
        ];

        function getCategory(itemName) {
            return itemCategories[itemName] || 'Outros';
        }

        const pedidosContainer = document.getElementById('pedidos-container');
        const modal = document.getElementById('pedido-modal');
        const modalContent = document.getElementById('modal-content');

        onSnapshot(collection(db, "pedidosCafe"), (snapshot) => {
            pedidosData = [];
            snapshot.forEach((doc) => {
                pedidosData.push({ id: doc.id, ...doc.data() });
            });
            // Ordena por data (mais recente primeiro) e depois por status (novos primeiro)
            pedidosData.sort((a, b) => {
                if (a.impresso !== b.impresso) {
                    return a.impresso ? 1 : -1;
                }
                return b.timestamp.seconds - a.timestamp.seconds;
            });
            renderPedidos();
        });

        function renderPedidos() {
            pedidosContainer.innerHTML = '';
            if (pedidosData.length === 0) {
                pedidosContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center">Nenhum pedido encontrado.</p>';
                return;
            }

            pedidosData.forEach(pedido => {
                const card = document.createElement('div');
                card.className = `card p-5 flex flex-col justify-between transition-transform transform hover:scale-105 ${pedido.impresso ? 'opacity-50 border-gray-600' : 'border-primary'}`;
                
                const dataPedido = new Date(pedido.timestamp.seconds * 1000).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric'});
                const horaPedido = new Date(pedido.timestamp.seconds * 1000).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit'});

                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-2xl font-bold text-primary">Cabana ${pedido.numeroCabana}</h2>
                            <span class="text-sm font-medium py-1 px-3 rounded-full ${pedido.impresso ? 'bg-gray-700 text-gray-300' : 'bg-primary text-primary-foreground animate-pulse'}">
                                ${pedido.impresso ? 'Impresso' : 'Novo'}
                            </span>
                        </div>
                        <p class="text-gray-300 font-medium">${pedido.nomeHospede}</p>
                        <p class="text-sm text-gray-400">${dataPedido} às ${horaPedido}</p>
                    </div>
                    <div class="mt-6 flex flex-col space-y-2">
                        <button class="btn-detalhes btn-primary w-full text-center font-semibold py-2 px-4 rounded-md" data-id="${pedido.id}">Ver Detalhes</button>
                    </div>
                `;
                pedidosContainer.appendChild(card);
            });
        }

        function abrirModalDetalhes(pedido) {
            // --- MELHORIA: Agrupamento de itens por categoria ---
            const groupedItems = {};
            (pedido.itens || []).forEach(item => {
                const category = getCategory(item.name);
                if (!groupedItems[category]) {
                    groupedItems[category] = [];
                }
                groupedItems[category].push(item);
            });

            let itensHtml = '';
            categoryOrder.forEach(category => {
                if (groupedItems[category]) {
                    itensHtml += `<h4 class="text-lg font-semibold mt-4 mb-2 text-primary border-b border-border pb-1">${category}</h4>`;
                    itensHtml += groupedItems[category].map(item => `
                        <div class="flex justify-between py-1 ml-2">
                            <span>- ${item.name}</span>
                            <span class="font-medium">${item.quantity}x</span>
                        </div>
                    `).join('');
                }
            });

            const dataPedido = new Date(pedido.timestamp.seconds * 1000);
            modalContent.innerHTML = `
                 <button id="btn-fechar-modal-inner" class="absolute top-4 right-4 text-gray-400 hover:text-white text-3xl">&times;</button>
                <div id="comanda-individual-content">
                    <h3 class="text-3xl font-bold mb-2 text-primary">Cabana ${pedido.numeroCabana}</h3>
                    <p class="mb-4 text-gray-400">Pedido de ${pedido.nomeHospede}</p>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <p><strong>Data:</strong> ${dataPedido.toLocaleDateString()}</p>
                        <p><strong>Hora:</strong> ${dataPedido.toLocaleTimeString()}</p>
                        <p><strong>Hóspedes:</strong> ${pedido.numeroHospedes}</p>
                    </div>

                    <div class="mt-4">
                        <h4 class="text-2xl font-bold mb-3">Itens do Pedido</h4>
                        ${itensHtml.length > 0 ? itensHtml : '<p>Nenhum item neste pedido.</p>'}
                    </div>

                    <div class="mt-6">
                        <h4 class="text-2xl font-bold mb-3">Observações</h4>
                        <p class="p-3 border border-border rounded-md min-h-[60px] bg-secondary">${pedido.observacoes || 'Nenhuma observação.'}</p>
                    </div>
                </div>

                <div class="mt-8 flex flex-col md:flex-row gap-4">
                     <button id="btn-imprimir-individual" class="btn-primary font-bold py-3 px-6 rounded-lg flex-1">Imprimir Comanda</button>
                     <button id="btn-marcar-impresso" class="btn-secondary font-bold py-3 px-6 rounded-lg flex-1" data-id="${pedido.id}">Marcar como Impresso</button>
                </div>
            `;
            modal.classList.remove('hidden');
            
            document.getElementById('btn-marcar-impresso').addEventListener('click', () => marcarComoImpresso(pedido.id));
            document.getElementById('btn-imprimir-individual').addEventListener('click', () => gerarComandaIndividual());
            document.getElementById('btn-fechar-modal-inner').addEventListener('click', fecharModal);

        }
        
        function fecharModal() {
            modal.classList.add('hidden');
        }
        
        async function marcarComoImpresso(id) {
            try {
                const pedidoRef = doc(db, "pedidosCafe", id);
                await updateDoc(pedidoRef, { impresso: true });
                alert('Pedido marcado como impresso!');
                fecharModal();
            } catch (error) {
                console.error("Erro ao marcar como impresso: ", error);
                alert('Ocorreu um erro. Tente novamente.');
            }
        }

        // --- MELHORIA: Comanda Geral com resumo e totalização de itens ---
        function gerarComandaGeral() {
            const pedidosNovos = pedidosData.filter(p => !p.impresso);
            if (pedidosNovos.length === 0) {
                alert("Não há pedidos novos para imprimir.");
                return;
            }

            const cabanasComPedidos = new Set(pedidosNovos.map(p => p.numeroCabana));
            const cabanasArray = [...cabanasComPedidos].sort((a, b) => a - b);

            let resumoHtml = `
                <div class="resumo">
                    <h2>Resumo de Pedidos Novos</h2>
                    <p><strong>Total de cabanas com pedidos:</strong> ${cabanasArray.length}</p>
                    <p><strong>Cabanas:</strong> ${cabanasArray.join(', ')}</p>
                </div>
                <hr style="margin: 20px 0; border-style: dashed;">
            `;

            const todosItens = {};
            pedidosNovos.forEach(pedido => {
                (pedido.itens || []).forEach(item => {
                    const chave = `${getCategory(item.name)}|${item.name}`;
                    if (!todosItens[chave]) {
                        todosItens[chave] = 0;
                    }
                    todosItens[chave] += item.quantity;
                });
            });
            
            const itensAgrupados = {};
            Object.entries(todosItens).forEach(([chave, quantidade]) => {
                const [categoria, nome] = chave.split('|');
                if(!itensAgrupados[categoria]) {
                    itensAgrupados[categoria] = [];
                }
                itensAgrupados[categoria].push({name: nome, quantity: quantidade});
            });


            let itensHtml = '<h2>Total de Itens</h2>';
            categoryOrder.forEach(cat => {
                if(itensAgrupados[cat]) {
                    itensHtml += `<div class="item-categoria"><h4>${cat}</h4>`;
                    itensAgrupados[cat].sort((a, b) => a.name.localeCompare(b.name)).forEach(item => {
                         itensHtml += `<p>${item.name}: <strong>${item.quantity}x</strong></p>`;
                    });
                    itensHtml += `</div>`;
                }
            });

            const comandaFinalHtml = `
                <div style="font-family: Arial, sans-serif; padding: 20px;">
                    <h1>Comanda Geral - ${new Date().toLocaleString('pt-BR')}</h1>
                    ${resumoHtml}
                    ${itensHtml}
                </div>
            `;
            
            document.getElementById('print-area').innerHTML = comandaFinalHtml;
            window.print();
        }

        function gerarComandaIndividual() {
            const conteudo = document.getElementById('comanda-individual-content').innerHTML;
            document.getElementById('print-area').innerHTML = `<div style="font-family: Arial, sans-serif; padding: 20px;">${conteudo}</div>`;
            window.print();
        }

        // --- Event Listeners ---
        document.getElementById('btn-comanda-geral').addEventListener('click', gerarComandaGeral);
        document.getElementById('btn-fechar-modal').addEventListener('click', fecharModal);
        
        pedidosContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-detalhes')) {
                const pedidoId = e.target.getAttribute('data-id');
                const pedido = pedidosData.find(p => p.id === pedidoId);
                if (pedido) {
                    abrirModalDetalhes(pedido);
                }
            }
        });
    </script>
</body>
</html>
